geom_point(data = archive_opt1,
aes(fx, dx, color = "no match"), alpha = 0.3) +
geom_point(data = boundary_ssps_match_opt1, aes(archive_fx, archive_dx,
color = "matched archive data")) +
geom_point(data = boundary_ssps_match_opt1, aes(target_fx, target_dx,
color = "target data"), alpha = 0.4) +
geom_text(data = boundary_ssps_match_opt1, aes(target_fx, target_dx,
label = target_year), size=2) +
geom_segment(data = boundary_ssps_match_opt1, aes(x = target_fx, y = target_dx,
xend = archive_fx, yend =  archive_dx), alpha = 0.4) +
scale_color_manual(values = c("matched archive data" = "red",
"target data" = "blue", "no match" = "grey"))+
theme_bw() +
labs(y = "window_size * dx (window_size * rate of change per chunk, degC)",
x = "fx (value of median temperature per chunk, degC)",
title = "Matching target (ssp245) with archive (ssp126 and ssp585)" )
ggplot() +
geom_point(data = archive_opt1,
aes(fx, dx, color = "no match"), alpha = 0.3) +
geom_point(data = boundary_ssps_match_opt1, aes(archive_fx, archive_dx,
color = "matched archive data")) +
geom_point(data = boundary_ssps_match_opt1, aes(target_fx, target_dx,
color = "target data"), alpha = 0.4) +
geom_text(data = boundary_ssps_match_opt1, aes(target_fx, target_dx,
label = target_year), size=2) +
geom_segment(data = boundary_ssps_match_opt1, aes(x = target_fx, y = target_dx,
xend = archive_fx, yend =  archive_dx), alpha = 0.4) +
scale_color_manual(values = c("matched archive data" = "red",
"target data" = "blue", "no match" = "grey"))+
coord_fixed() +
theme_bw() +
labs(y = "window_size * dx (window_size * rate of change per chunk, degC)",
x = "fx (value of median temperature per chunk, degC)",
title = "Matching target (ssp245) with archive (ssp126 and ssp585)" )
ggplot() +
geom_point(data = archive_opt1,
aes(fx, dx, color = "no match"), alpha = 0.3) +
geom_point(data = boundary_ssps_match_opt1, aes(archive_fx, archive_dx,
color = "matched archive data")) +
geom_point(data = boundary_ssps_match_opt1, aes(target_fx, target_dx,
color = "target data"), alpha = 0.4) +
geom_text(data = boundary_ssps_match_opt1, aes(target_fx, target_dx,
label = target_year), size=2) +
geom_segment(data = boundary_ssps_match_opt1, aes(x = target_fx, y = target_dx,
xend = archive_fx, yend =  archive_dx), alpha = 0.4) +
scale_color_manual(values = c("matched archive data" = "red",
"target data" = "blue", "no match" = "grey"))+
coord_fixed() +
theme_bw() +
labs(y = "window_size * dx (window_size * rate of change per chunk, degC)",
x = "fx (value of median temperature per chunk, degC)",
title = "Matching target (ssp245) with archive (ssp126 and ssp585)" )
ggplot() +
geom_point(data = archive_opt1,
aes(fx, dx, color = "no match"), alpha = 0.3) +
geom_point(data = boundary_ssps_match_opt1, aes(archive_fx, archive_dx,
color = "matched archive data")) +
geom_point(data = boundary_ssps_match_opt1, aes(target_fx, target_dx,
color = "target data"), alpha = 0.4) +
geom_text(data = boundary_ssps_match_opt1, aes(target_fx, target_dx,
label = target_year), size=2) +
geom_segment(data = boundary_ssps_match_opt1, aes(x = target_fx, y = target_dx,
xend = archive_fx, yend =  archive_dx), alpha = 0.4) +
scale_color_manual(values = c("matched archive data" = "red",
"target data" = "blue", "no match" = "grey"))+
xlim(-1,7) + ylim(-1,7)
theme_bw() +
labs(y = "window_size * dx (window_size * rate of change per chunk, degC)",
x = "fx (value of median temperature per chunk, degC)",
title = "Matching target (ssp245) with archive (ssp126 and ssp585)" )
ggplot() +
geom_point(data = archive_opt1,
aes(fx, dx, color = "no match"), alpha = 0.3) +
geom_point(data = boundary_ssps_match_opt1, aes(archive_fx, archive_dx,
color = "matched archive data")) +
geom_point(data = boundary_ssps_match_opt1, aes(target_fx, target_dx,
color = "target data"), alpha = 0.4) +
geom_text(data = boundary_ssps_match_opt1, aes(target_fx, target_dx,
label = target_year), size=2) +
geom_segment(data = boundary_ssps_match_opt1, aes(x = target_fx, y = target_dx,
xend = archive_fx, yend =  archive_dx), alpha = 0.4) +
scale_color_manual(values = c("matched archive data" = "red",
"target data" = "blue", "no match" = "grey"))+
xlim(-1,7) + ylim(-1,7) +
theme_bw() +
labs(y = "window_size * dx (window_size * rate of change per chunk, degC)",
x = "fx (value of median temperature per chunk, degC)",
title = "Matching target (ssp245) with archive (ssp126 and ssp585)" )
ggplot() +
geom_point(data = archive_opt1,
aes(fx, dx, color = "no match"), alpha = 0.3) +
geom_point(data = boundary_ssps_match_opt1, aes(archive_fx, archive_dx,
color = "matched archive data")) +
geom_point(data = boundary_ssps_match_opt1, aes(target_fx, target_dx,
color = "target data"), alpha = 0.4) +
geom_text(data = boundary_ssps_match_opt1, aes(target_fx, target_dx,
label = target_year), size=2) +
geom_segment(data = boundary_ssps_match_opt1, aes(x = target_fx, y = target_dx,
xend = archive_fx, yend =  archive_dx), alpha = 0.4) +
scale_color_manual(values = c("matched archive data" = "red",
"target data" = "blue", "no match" = "grey"))+
coord_fixed() +
theme_bw() +
labs(y = "adj. dx (degC)",
x = "fx (value of median temperature per chunk, degC)",
title = "Matching target (ssp245) with archive (ssp126 and ssp585)" )
ggplot() +
geom_point(data = archive_opt1,
aes(fx, dx, color = "no match"), alpha = 0.3) +
geom_point(data = boundary_ssps_match_opt1, aes(archive_fx, archive_dx,
color = "matched archive data")) +
geom_point(data = boundary_ssps_match_opt1, aes(target_fx, target_dx,
color = "target data"), alpha = 0.4) +
geom_text(data = boundary_ssps_match_opt1, aes(target_fx, target_dx,
label = target_year), size=2) +
geom_segment(data = boundary_ssps_match_opt1, aes(x = target_fx, y = target_dx,
xend = archive_fx, yend =  archive_dx), alpha = 0.4) +
scale_color_manual(values = c("matched archive data" = "red",
"target data" = "blue", "no match" = "grey"))+
xlim(-1, 6.5) + ylim(-1,6.5) +
theme_bw() +
labs(y = "adj. dx (degC)",
x = "fx (value of median temperature per chunk, degC)",
title = "Matching target (ssp245) with archive (ssp126 and ssp585)" )
ggplot() +
geom_point(data = archive_opt1,
aes(fx, dx, color = "no match"), alpha = 0.3) +
geom_point(data = boundary_ssps_match_opt1, aes(archive_fx, archive_dx,
color = "matched archive data")) +
geom_point(data = boundary_ssps_match_opt1, aes(target_fx, target_dx,
color = "target data"), alpha = 0.4) +
geom_text(data = boundary_ssps_match_opt1, aes(target_fx, target_dx,
label = target_year), size=2) +
geom_segment(data = boundary_ssps_match_opt1, aes(x = target_fx, y = target_dx,
xend = archive_fx, yend =  archive_dx), alpha = 0.4) +
scale_color_manual(values = c("matched archive data" = "red",
"target data" = "blue", "no match" = "grey"))+
xlim(-1, 6.5) + ylim(-1,6.5) +
theme_bw() +
labs(y = "adj. dx (degC)",
x = "fx (value of median temperature per chunk, degC)",
title = "Matching target (ssp245) with archive (ssp126 and ssp585)" )
ggplot() +
geom_point(data = archive_opt1,
aes(fx, dx, color = "no match"), alpha = 0.3) +
geom_point(data = boundary_ssps_match_opt1, aes(archive_fx, archive_dx,
color = "matched archive data")) +
geom_point(data = boundary_ssps_match_opt1, aes(target_fx, target_dx,
color = "target data"), alpha = 0.4) +
geom_text(data = boundary_ssps_match_opt1, aes(target_fx, target_dx,
label = target_year), size=2) +
geom_segment(data = boundary_ssps_match_opt1, aes(x = target_fx, y = target_dx,
xend = archive_fx, yend =  archive_dx), alpha = 0.4) +
scale_color_manual(values = c("matched archive data" = "red",
"target data" = "blue", "no match" = "grey"))+
coord_fixed() +
theme_bw() +
labs(y = "adj. dx (degC)",
x = "fx (value of median temperature per chunk, degC)",
title = "Matching target (ssp245) with archive (ssp126 and ssp585)" )
ggplot() +
geom_point(data = archive_opt1,
aes(fx, dx, color = "no match"), alpha = 0.3) +
geom_point(data = boundary_ssps_match_opt1, aes(archive_fx, archive_dx,
color = "matched archive data")) +
geom_point(data = boundary_ssps_match_opt1, aes(target_fx, target_dx,
color = "target data"), alpha = 0.4) +
geom_text(data = boundary_ssps_match_opt1, aes(target_fx, target_dx,
label = target_year), size=2) +
geom_segment(data = boundary_ssps_match_opt1, aes(x = target_fx, y = target_dx,
xend = archive_fx, yend =  archive_dx), alpha = 0.4) +
scale_color_manual(values = c("matched archive data" = "red",
"target data" = "blue", "no match" = "grey"))+
xlim(-1, 7) + ylim(-1,7) +
theme_bw() +
labs(y = "adj. dx (degC)",
x = "fx (value of median temperature per chunk, degC)",
title = "Matching target (ssp245) with archive (ssp126 and ssp585)" )
ggplot() +
geom_point(data = archive_opt1,
aes(fx, dx, color = "no match"), alpha = 0.3) +
geom_point(data = boundary_ssps_match_opt1, aes(archive_fx, archive_dx,
color = "matched archive data")) +
geom_point(data = boundary_ssps_match_opt1, aes(target_fx, target_dx,
color = "target data"), alpha = 0.4) +
geom_text(data = boundary_ssps_match_opt1, aes(target_fx, target_dx,
label = target_year), size=2) +
geom_segment(data = boundary_ssps_match_opt1, aes(x = target_fx, y = target_dx,
xend = archive_fx, yend =  archive_dx), alpha = 0.4) +
scale_color_manual(values = c("matched archive data" = "red",
"target data" = "blue", "no match" = "grey"))+
xlim(-1, 7) + ylim(-1,7) +
theme_bw() +
labs(y = "adj. dx (degC)",
x = "fx (value of median temperature per chunk, degC)",
title = "Matching target (ssp245) with archive (ssp126 and ssp585)" )
ggsave('opt1_scatter.png', p, width = 12, height = 6, units = 'in')
archive_data
head(archive_data)
source('~/.active-rstudio-document', echo=TRUE)
archive_data %>%
group_by(variable, model, experiment) %>%
summarize(fx_sd = sd(fx),
dx_sd = sd(dx)) %>%
ungroup ->
archive_sd1
archive_sd1
archive_data %>%
filter(experiment %in% c("ssp126", "ssp585")) %>%
left_join(archive_sdA, by=c('variable', 'model', 'experiment'))
archive_data %>%
group_by(variable, model, experiment) %>%
summarize(fx_sd = sd(fx),
dx_sd = sd(dx)) %>%
ungroup ->
archive_sdA
archive_data %>%
filter(experiment %in% c("ssp126", "ssp585")) %>%
left_join(archive_sdA, by=c('variable', 'model', 'experiment'))
archive_data %>%
filter(experiment %in% c("ssp126", "ssp585")) %>%
left_join(archive_sdA, by=c('variable', 'model', 'experiment')) %>% head()
archive_data %>%
group_by(variable, model, experiment) %>%
summarize(sd_fx = sd(fx),
sd_dx = sd(dx)) %>%
ungroup ->
archive_sdA
archive_data %>%
filter(experiment %in% c("ssp126", "ssp585")) %>%
left_join(archive_sdA, by=c('variable', 'model', 'experiment')) %>%
mutate(fx = fx/sd_fx,
dx = dx/sd_dx) ->
archive_opt2a
head(archive_opt2a)
archive_data %>%
filter(experiment %in% c("ssp126", "ssp585")) %>%
left_join(archive_sdA, by=c('variable', 'model', 'experiment')) %>%
mutate(fx_old = fx,
fx = fx/sd_fx,
dx_old = dx,
dx = dx/sd_dx) ->
archive_opt2a
head(archive_opt2a)
source('~/.active-rstudio-document', echo=TRUE)
source('~/.active-rstudio-document', echo=TRUE)
head(boundary_ssps_match_opt1)
head(boundary_ssps_match_opt1)
head(boundary_ssps_match_opt2a)
source('~/.active-rstudio-document', echo=TRUE)
head( boundary_ssps_match_opt2a)
source('~/.active-rstudio-document', echo=TRUE)
head(boundary_ssps_match_opt2a)
head(boundary_ssps_match_opt2a)
library(dplyr)
library(tidyr)
library(ggplot2)
library(knitr)
# library(kableExtra)
# Load the functions that we will use!
source("nearest_neighbor_matching.R")
source("stitching_functions.R")
# The tgav anomaly data (smoothed?)
tgav_data <- read.csv("inputs/tgav_data.csv", stringsAsFactors = FALSE)
# The archive of data: tgav anomalies converted to chunked windows with
# fx and dx calculated.
archive_data <- read.csv('inputs/archive_data.csv', stringsAsFactors = FALSE)
# The target dta is just the archive data, filtered to be ssp245 realization 1.
# Saved and read in for convenience.
target_data <- read.csv("inputs/target_data.csv", stringsAsFactors = FALSE)
head(archive_data)
archive_data %>%
filter(experiment %in% c("ssp126", "ssp585")) %>% head
archive_data %>%
filter(experiment %in% c( "ssp585")) %>% head
head(tgav_data)
source('~/.active-rstudio-document', echo=TRUE)
head(boundary_ssps_match_opt2b)
head(out4)
out4 <- stitch_global_mean(data = tgav_data, match = boundary_ssps_match_opt2b)
out4$name <- "sd by experiment*ensemble"
head(out4)
head(boundary_ssps_match_opt2b)
head( boundary_ssps_match_opt2b)
# check the match input make sure that the values are
req_target_cols <- paste0("target_", c("variable", "start_yr", "end_yr"))
req_archive_cols <- paste0("archive_",  c("model", "start_yr", "end_yr",
"experiment", "variable", "model", "ensemble"))
boundary_ssps_match_opt2b %>%
select(req_target_cols, req_archive_cols)
library(dplyr)
library(tidyr)
library(ggplot2)
library(knitr)
# library(kableExtra)
# Load the functions that we will use!
source("nearest_neighbor_matching.R")
source("stitching_functions.R")
# The tgav anomaly data (unsmoothed, for constructing new realizations)
tgav_data <- read.csv("inputs/tgav_data.csv", stringsAsFactors = FALSE)
# The archive of data: smoothed tgav anomalies converted to chunked windows with
# fx and dx calculated.
archive_data <- read.csv('inputs/archive_data.csv', stringsAsFactors = FALSE)
# The target dta is just the archive data, filtered to be ssp245 realization 1.
# Saved and read in for convenience.
target_data <- read.csv("inputs/target_data.csv", stringsAsFactors = FALSE)
head(archive_data)
archive_data %>%
filter(year >= 2015) %>%
group_by(variable, model, experiment) %>%
summarize(sd_fx = sd(fx),
sd_dx = sd(dx)) %>%
ungroup ->
archive_sdA
archive_data %>%
filter(year < 2015) %>% head
archive_data %>%
filter(year >= 2015) %>%
group_by(variable, model, experiment) %>%
summarize(sd_fx = sd(fx),
sd_dx = sd(dx)) %>%
ungroup ->
archive_sdA
archive_data %>%
filter(year < 2015) %>%
select(-experiment) %>%
distinct %>%
group_by(variable, model) %>%
summarize(sd_fx = sd(fx),
sd_dx = sd(dx)) %>%
ungroup ->
archive_sdA_hist
archive_data %>%
filter(year < 2015) %>%
select(-experiment) %>%
distinct %>% nrow()
archive_data %>%
filter(year < 2015) %>%
select(-experiment) %>%
distinct -> x
head(x)
boundary_ssps_match_opt2b %>% head
source('~/.active-rstudio-document', echo=TRUE)
boundary_ssps_match_opt2b %>% head
boundary_ssps_match_opt2b %>% filter(target_year >2040 & target_year <= 2060) -> x
x
matched
# THe matched data in that year:
boundary_ssps_match_opt2b %>%
filter(target_year ==2052) ->
matched
kable(matched)
# THe matched data in that year:
boundary_ssps_match_opt2b %>%
filter(target_year ==2052) ->
matched_metadata
kable(matched_metadata)
head(tgav_data)
# the unsmoothed tgav data:
tgav_data %>%
filter(model == unique(matched_metadata$archive_model),
experiment == unique(matched_metadata$archive_experiment),
ensemble == unique(matched_metadata$ensemble),
year >= unique(matched_metadata$archive_start_yr),
year <= unique(matched_metadata$archive_end_yr)) ->
matched_tgav
unique(matched_metadata$archive_model)
tgav_data %>%
filter(model == unique(matched_metadata$archive_model))
tgav_data %>%
filter(model == unique(matched_metadata$archive_model),
experiment == unique(matched_metadata$archive_experiment),
ensemble == unique(matched_metadata$ensemble) )
# the unsmoothed tgav data:
tgav_data %>%
filter(model == unique(matched_metadata$archive_model),
experiment == unique(matched_metadata$archive_experiment),
ensemble == unique(matched_metadata$archive_ensemble),
year >= unique(matched_metadata$archive_start_yr),
year <= unique(matched_metadata$archive_end_yr)) ->
matched_tgav
matched_tgav
# the unsmoothed tgav data:
tgav_data %>%
filter(model == unique(matched_metadata$archive_model),
experiment == unique(matched_metadata$archive_experiment),
ensemble == unique(matched_metadata$archive_ensemble),
year >= unique(matched_metadata$archive_start_yr),
year <= unique(matched_metadata$archive_end_yr)) %>%
mutate(newyr = c(unique(matched_metadata$target_start_yr):unique(matched_metadata$target_end_yr))) ->
matched_tgav
matched_year
matched_tgav
tgav_data %>%
filter(model == unique(matched_metadata$archive_model),
experiment == unique(matched_metadata$archive_experiment),
ensemble == unique(matched_metadata$archive_ensemble),
year >= unique(matched_metadata$archive_start_yr),
year <= unique(matched_metadata$archive_end_yr)) %>%
mutate(tgav_year = year,
year = c(unique(matched_metadata$target_start_yr):unique(matched_metadata$target_end_yr))) ->
matched_tgav
matched_tgav
head(out4)
matched_tgav %>%
select(-file) %>% #drop the pangeo file locations for prettier printing here
left_join(out4, by = c('year', 'variable') )
# the unsmoothed tgav data:
tgav_data %>%
filter(model == unique(matched_metadata$archive_model),
experiment == unique(matched_metadata$archive_experiment),
ensemble == unique(matched_metadata$archive_ensemble),
year >= unique(matched_metadata$archive_start_yr),
year <= unique(matched_metadata$archive_end_yr)) %>%
mutate(tgav_year = year,
year = c(unique(matched_metadata$target_start_yr):unique(matched_metadata$target_end_yr)),
tgav_value = value) ->
matched_tgav
# Compare to what the stitching function output:
matched_tgav %>%
select(-file) %>% #drop the pangeo file locations for prettier printing here
left_join(out4, by = c('year', 'variable') )
# the unsmoothed tgav data:
tgav_data %>%
filter(model == unique(matched_metadata$archive_model),
experiment == unique(matched_metadata$archive_experiment),
ensemble == unique(matched_metadata$archive_ensemble),
year >= unique(matched_metadata$archive_start_yr),
year <= unique(matched_metadata$archive_end_yr)) %>%
mutate(tgav_year = year,
year = c(unique(matched_metadata$target_start_yr):unique(matched_metadata$target_end_yr))) %>%
rename(tgav_value = tgav) ->
matched_tgav
# the unsmoothed tgav data:
tgav_data %>%
filter(model == unique(matched_metadata$archive_model),
experiment == unique(matched_metadata$archive_experiment),
ensemble == unique(matched_metadata$archive_ensemble),
year >= unique(matched_metadata$archive_start_yr),
year <= unique(matched_metadata$archive_end_yr)) %>%
mutate(tgav_year = year,
year = c(unique(matched_metadata$target_start_yr):unique(matched_metadata$target_end_yr))) %>%
rename(tgav_value = value) ->
matched_tgav
# Compare to what the stitching function output:
matched_tgav %>%
select(-file) %>% #drop the pangeo file locations for prettier printing here
left_join(out4, by = c('year', 'variable') )
# the unsmoothed tgav data:
tgav_data %>%
filter(model == unique(matched_metadata$archive_model),
experiment == unique(matched_metadata$archive_experiment),
ensemble == unique(matched_metadata$archive_ensemble),
year >= unique(matched_metadata$archive_start_yr),
year <= unique(matched_metadata$archive_end_yr)) %>%
mutate(tgav_year = year,
year = c(unique(matched_metadata$target_start_yr):unique(matched_metadata$target_end_yr))) %>%
rename(tgav_value = value) ->
matched_tgav
# Compare to what the stitching function output:
matched_tgav %>%
select(-model, -experiment, -ensemble, -timestep, -grid_type, -file) %>%
left_join(out4, by = c('year', 'variable') )
head(boundary_ssps_match_opt2b)
p <- ggplot() +
geom_point(data = archive_opt2b,
aes(fx, dx, color = "no match"), alpha = 0.3) +
geom_point(data = boundary_ssps_match_opt2b, aes(archive_fx, archive_dx,
label = interaction(archive_experiment,
archive_ensemble,
archive_year)),
size = 1.8) +
geom_text(data = boundary_ssps_match_opt2b, aes(archive_fx, archive_dx,
color = "matched archive data")) +
geom_point(data = boundary_ssps_match_opt2b, aes(target_fx, target_dx,
color = "target data"), alpha = 0.4) +
geom_text(data = boundary_ssps_match_opt2b, aes(target_fx, target_dx,
label = target_year), size=2) +
geom_segment(data = boundary_ssps_match_opt2b, aes(x = target_fx, y = target_dx,
xend = archive_fx, yend =  archive_dx), alpha = 0.4) +
scale_color_manual(values = c("matched archive data" = "red",
"target data" = "blue", "no match" = "grey"))+
xlim(-3, 7.6) + ylim(-3, 7.6)+
theme_bw() +
labs(y = "adj. dx (unitless)",
x = "adj. fx (unitless)",
title = "Matching target (ssp245) with archive (ssp126 and ssp585)" )
p
p <- ggplot() +
geom_point(data = archive_opt2b,
aes(fx, dx, color = "no match"), alpha = 0.3) +
geom_point(data = boundary_ssps_match_opt2b,
aes(archive_fx, archive_dx,label = interaction(archive_experiment,
archive_ensemble,
archive_year)),
size = 1.8) +
geom_text(data = boundary_ssps_match_opt2b, aes(archive_fx, archive_dx,
color = "matched archive data")) +
geom_point(data = boundary_ssps_match_opt2b, aes(target_fx, target_dx,
color = "target data"), alpha = 0.4) +
geom_text(data = boundary_ssps_match_opt2b, aes(target_fx, target_dx,
label = target_year), size=2) +
geom_segment(data = boundary_ssps_match_opt2b, aes(x = target_fx, y = target_dx,
xend = archive_fx, yend =  archive_dx), alpha = 0.4) +
scale_color_manual(values = c("matched archive data" = "red",
"target data" = "blue", "no match" = "grey"))+
xlim(-3, 7.6) + ylim(-3, 7.6)+
theme_bw() +
labs(y = "adj. dx (unitless)",
x = "adj. fx (unitless)",
title = "Matching target (ssp245) with archive (ssp126 and ssp585)" )
p
